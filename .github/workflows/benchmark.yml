name: Benchmark

on:
  workflow_dispatch:
    inputs:
      num_pairs:
        description: 'Number of key-value pairs to insert'
        required: false
        default: '500000'
        type: string
      pattern:
        description: 'Split probability pattern (0.0001-0.5, lower = larger nodes)'
        required: false
        default: '0.25'
        type: string
      store_type:
        description: 'Storage backend type'
        required: false
        default: 'memory'
        type: choice
        options:
          - memory
          - filesystem
          - cached
      compare_mode:
        description: 'Run comparison across different patterns'
        required: false
        default: false
        type: boolean

jobs:
  benchmark:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Set up Python 3.13
      uses: actions/setup-python@v5
      with:
        python-version: "3.13"

    - name: Install uv
      uses: astral-sh/setup-uv@v3

    - name: Install dependencies
      run: uv sync --extra dev

    - name: Run benchmark (standard mode)
      if: ${{ !inputs.compare_mode }}
      run: |
        uv run python scripts/benchmark.py \
          --num-pairs ${{ inputs.num_pairs }} \
          --pattern ${{ inputs.pattern }} \
          --store ${{ inputs.store_type }}

    - name: Run benchmark (comparison mode)
      if: ${{ inputs.compare_mode }}
      run: |
        uv run python scripts/benchmark.py \
          --num-pairs ${{ inputs.num_pairs }} \
          --store ${{ inputs.store_type }} \
          --compare

    - name: Save benchmark results
      if: always()
      run: |
        mkdir -p benchmark-results
        echo "Benchmark run: $(date)" > benchmark-results/info.txt
        echo "Num pairs: ${{ inputs.num_pairs }}" >> benchmark-results/info.txt
        echo "Pattern: ${{ inputs.pattern }}" >> benchmark-results/info.txt
        echo "Store type: ${{ inputs.store_type }}" >> benchmark-results/info.txt
        echo "Compare mode: ${{ inputs.compare_mode }}" >> benchmark-results/info.txt

    - name: Upload benchmark results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: benchmark-results
        path: benchmark-results/
        retention-days: 30
